<html>

<head>


    <style>
        html {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 500;
        }

        #debug {
            line-height: 1.2
        }

        .code {
            font-family: "Lucida Console", Monaco, monospace;
            outline: thin, 1px, black;
            vertical-align: top;

            line-height: 1;
        }

        #panels>* {
            display: inline-block;
            min-width: 30%;
        }

        .palette-container {
            display: flex;

            margin-bottom: 20px;
        }

        .palette-square {
            outline: solid 1px black;

            display: inline-block;
            min-width: 48px;
            min-height: 48px;
        }

        .interactive {
            position: absolute;
            bottom: 20;
        }

        canvas {
            width: 320px;
            height: 288px;

            image-rendering: -moz-crisp-edges;
            /* Firefox */
            image-rendering: -webkit-crisp-edges;
            /* Webkit (Safari) */
            image-rendering: pixelated;
            /* Chrome */

            outline-style: solid;
            outline-width: thick;
            outline-color: black;

        }
    </style>


</head>

<body>
    <h1 style="margin-bottom: 0">Game Boy Emulator</h1>

    <div id="panels">
        <p class="panel" id="debug">

        </p>
        <!-- <b>Disassembly</b>  -->
        <span class="panel code" id="disassembly-output">

        </span>

        <div>
            <label>Palette</label>
            <div class="palette-container">
                <span class="palette-square" id="palette0"></span>
                <span class="palette-square" id="palette1"></span>
                <span class="palette-square" id="palette2"></span>
                <span class="palette-square" id="palette3"></span>
            </div>

            <canvas id="gameboy" width="160" height="144"></canvas>
        </div>

    </div>


    <div class="interactive">
        <button onclick="executeAtPc()">Execute at PC</button>
        <button onclick="executeAtPc(); cpu.khz()">Speed Execute</button>
        <button onclick="cpu.khzStop();">Halt Execute</button>
        <button onclick="cpu.bus.gpu.renderSingleFrame()">Render Frame</button>
        <button onclick="cpu.bus.gpu.executeUntilVblank()">Execute until vblank</button>
        <button onclick="console.log(cpu.registers)">Dump Registers</button>

        <div style="display: none">
            <label for="enableLogging">Enable Logging</label>
            <input id="enableLogging" autocomplete="off" type="checkbox">
        </div>

        <div>
            <label for="drawTileset">Draw Tileset</label>
            <input id="drawTileset" autocomplete="off" type="checkbox">
        </div>

        <div style="display: none">
            <button onclick="loadDefaultBootRom()">Load default Boot ROM</button>
        </div>

        <div style="display: none">
            <label for="bootromInput">Open Boot ROM</label>
            <input id="bootromInput" autocomplete="off" type="file">
        </div>


        <div>
            <label for="gameromInput">Open Game ROM</label>
            <input id="gameromInput" autocomplete="off" type="file">
        </div>

        <div>
            <label for="haltInput">Halt at 0x</label>
            <input id="haltInput" autocomplete="off" pattern="[a-fA-F\d]+" />
        </div>


        <div style="display: none">
            <label for="halt2Input">Halt when executed</label>
            <input id="halt2Input" type="number" />
        </div>


        <div style="display: none">
            <button onclick="downloadLog()">Download Log</button>
        </div>
    </div>





    <script>
        function loadDefaultBootRom() {
            const BOOTROM_BASE64 = `Mf7/ryH/nzLLfCD7ISb/DhE+gDLiDD7z4jI+d3c+/OBHEQQBIRCAGs2VAM2WABN7/jQg8xHYAAYIGhMiIwUg+T4Z6hCZIS+ZDgw9KAgyDSD5Lg8Y82c+ZFfgQj6R4EAEHgIODPBE/pAg+g0g9x0g8g4TJHweg/5iKAYewf5kIAZ74gw+h+LwQpDgQhUg0gUgTxYgGMtPBgTFyxEXwcsRFwUg9SIjIiPJzu1mZswNAAsDcwCDAAwADQAIER+IiQAO3Mxu5t3d2Zm7u2djbg7szN3cmZ+7uTM+PEK5pbmlQjwhBAERqAAaE74g/iN9/jQg9QYZeIYjBSD7hiD+PgHgUA==`
            let raw = atob(BOOTROM_BASE64);
            let rawLength = raw.length;

            let array = new Uint8Array(new ArrayBuffer(256));

            for (i = 0; i < rawLength; i++) {
                array[i] = raw.charCodeAt(i);
            }

            array.forEach((v, i, a) => {
                cpu.bus.bootrom[i] = v;
            });

            cpu.bootromLoaded = true;
            cpu.disassemble()
        }

        let disassemblyP = document.getElementById('disassembly-output');
        let lastDisassembly = "";

        function disassemble() {
            let disassembly = cpu.disassemble();
            if (lastDisassembly != disassembly) {
                disassemblyP.innerHTML = disassembly;
                lastDisassembly = disassembly;
            }
        }

        setInterval(disassemble, 1);

        function executeAtPc() {
            let cpu = window.cpu;
            let pc = cpu.pc
            cpu.debugging = false;
            if (cpu.breakpoints.has(pc)) {
                cpu.clearBreakpoint(pc);
                cpu.step();
                cpu.setBreakpoint(pc);
            } else {
                cpu.step();
            }
            

            disassemble();
        }

        function download(filename, text) {
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }

        function downloadLog() {
            download("EpicGameBoy.log", cpu.fullLog.join('\n'));
        }

        document.querySelector('#enableLogging').addEventListener('change', function (e) {
            cpu.logging = e.target.checked;
        }, false);

        let drawTilesetInterval = 0;
        document.querySelector('#drawTileset').addEventListener('change', function (e) {
            if (e.target.checked) {
                drawTilesetInterval = setInterval(() => {
                    cpu.bus.gpu.renderTiles();
                    cpu.bus.gpu.drawToCanvas();
                    cpu.bus.gpu.paintToCanvas = false;
                }, 10);
            } else {
                cpu.bus.gpu.paintToCanvas = true;
                clearInterval(drawTilesetInterval);
            }

        }, false);


        document.querySelector('#haltInput').addEventListener('change', function (e) {
            cpu.setBreakpoint(parseInt(`0x${e.target.value}`));
        }, false);
        document.querySelector('#halt2Input').addEventListener('change', function (e) {
            cpu.haltWhen = parseInt(`${e.target.value}`);
            console.log(`Set halt instructions executed to ${parseInt(cpu.haltWhen).toString(10)}`)
        }, false);

        document.querySelector('#bootromInput').addEventListener('change', function () {
            var reader = new FileReader();
            reader.onload = function () {
                var arrayBuffer = this.result;
                var array = new Uint8Array(arrayBuffer);

                array.forEach((v, i, a) => {
                    cpu.bus.bootrom[i] = v;
                });
            }
            reader.readAsArrayBuffer(this.files[0]);
            cpu.bootromLoaded = true;
        }, false);

        document.querySelector('#gameromInput').addEventListener('change', function () {
            loadDefaultBootRom();
            var reader = new FileReader();
            reader.onload = function () {
                var arrayBuffer = this.result;
                var array = new Uint8Array(arrayBuffer);

                array.forEach((v, i, a) => {
                    cpu.bus.rom[i] = v;
                });
                // cpu.khz()
                // cpu.bus.gpu.frameExecute();
            }
            reader.readAsArrayBuffer(this.files[0]);
        }, false);
    </script>
    <script src="gameboy/gameboy.js"></script>
    <script>
        cpu = new CPU();
        window.cpu = cpu;

        loadDefaultBootRom()
        startDebugging();
    </script>
</body>



</html>